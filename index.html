<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç§å¯†è¨˜å¸³æœ¬ â€” Face ID å¤šåŠŸèƒ½ç‰ˆ (v4)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<style>
:root{--bg:#fff;--fg:#111;--muted:#666;--border:#e5e7eb;--card:#f8fafc;--brand:#2563eb;--accent:#16a34a;--danger:#dc2626}
@media (prefers-color-scheme: dark){:root{--bg:#0b1220;--fg:#e5e7eb;--muted:#9aa6b2;--border:#1f2937;--card:#0f172a}}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial;background:var(--bg);color:var(--fg);line-height:1.6}
.container{max-width:880px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px;margin-top:12px}
h1{margin:0 0 8px;font-size:20px}
.small{font-size:13px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;font-weight:600}
button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
button.accent{background:var(--accent);color:#001;border-color:var(--accent)}
button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.progress{height:12px;background:var(--border);border-radius:999px;overflow:hidden;margin-top:8px;position:relative}
.progress>span{display:block;height:100%;background:var(--accent);width:0%;transition:width 0.3s}
.progress label{position:absolute;right:6px;top:-2px;font-size:12px;color:var(--fg)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
input,select{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--fg)}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.hidden{display:none}
#jsStatus{font-size:12px;padding:4px 8px;border-radius:8px;background:#eee;color:#333}
.listitem{display:flex;justify-content:space-between;align-items:center;margin-top:4px;padding:4px 0;border-bottom:1px solid var(--border)}
.smallbtn{font-size:13px;padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
<div class="container">
  <div class="card" id="intro">
    <h1>superbike-dream <span class="small">(v4)</span></h1>
    <div class="toolbar">
      <span id="jsStatus">JS æª¢æŸ¥ä¸­â€¦</span>
      <button id="btnDebug" class="smallbtn">Debug</button>
    </div>
    <div class="toolbar">
      <button id="btnRegister" class="primary">å•Ÿç”¨ Face IDï¼ˆè¨»å†Šï¼‰</button>
      <button id="btnLogin" class="accent hidden">ä½¿ç”¨ Face ID ç™»å…¥</button>
    </div>
  </div>

  <div id="app" class="card hidden" aria-hidden="true">
    <h2 style="margin-top:0">è¨˜å¸³å€</h2>
    <div class="small">ç›®æ¨™ï¼š<span id="targetShow">300000</span>ã€€ç´¯ç©å­˜æ¬¾ï¼š<strong id="savedTotal">0</strong></div>
    <div class="progress"><span id="bar"></span><label id="barpct"></label></div>

    <div class="row">
      <div><label>æœˆä»½</label><input id="monthPick" type="month"></div>
      <div><label>èµ·å§‹é‡‘é¡</label><input id="start" type="number"></div>
    </div>
    <div class="row">
      <div><label>é è¨ˆé–‹éŠ·</label><input id="plan" type="number" placeholder="è¼¸å…¥å¾Œæœƒé–å®š"></div>
      <div><label>é¡å‹</label><select id="type"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
    </div>
    <div class="row">
      <div><label>åˆ†é¡</label><select id="cat"></select></div>
      <div><label>é‡‘é¡</label><input id="amount" type="number"></div>
    </div>
    <div><input id="note" placeholder="å‚™è¨»"></div>
    <div class="toolbar"><button id="btnAdd" class="primary">åŠ å…¥</button><button id="btnExport" class="smallbtn">åŒ¯å‡º</button><button id="btnLock" class="smallbtn">ä¸Šé–</button></div>

    <div class="note" id="summary"></div>
    <div style="margin-top:12px"><strong>æœ¬æœˆæ˜ç´°</strong><div id="listArea"></div></div>
  </div>

  <div id="debt" class="card hidden" aria-hidden="true">
    <h2 style="margin-top:0">æ¬ æ¬¾ç´€éŒ„</h2>
    <div class="row"><div><input id="debtor" placeholder="å§“å"></div><div><input id="debtamt" type="number" placeholder="é‡‘é¡"></div></div>
    <div class="toolbar"><button id="btnAddDebt" class="primary">åŠ å…¥</button></div>
    <div id="debtList"></div>
  </div>
</div>

<script>
(function(){
const $=s=>document.querySelector(s);
let DB={version:4,target:300000,months:{},debts:[]};
const STORAGE_KEY='nbudget.v4';
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(DB));}
function load(){const s=localStorage.getItem(STORAGE_KEY);if(s){try{DB=JSON.parse(s);}catch(e){}}}
function ym(d=new Date()){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
function daysInMonth(y,m){return new Date(y, m, 0).getDate();} // m: 1-12
function ensureMonth(k){if(!DB.months[k])DB.months[k]={start:0,plan:null,entries:[],counter:0};return DB.months[k];}
function statsAll(){return Object.keys(DB.months).reduce((s,k)=>{const m=DB.months[k];const inc=(m.entries||[]).filter(x=>x.type==='income').reduce((a,b)=>a+b.amount,0);const exp=(m.entries||[]).filter(x=>x.type==='expense').reduce((a,b)=>a+b.amount,0);return s+((m.start||0)+inc-exp);},0);}

function supported(){return !!(window.PublicKeyCredential&&navigator.credentials);}
function hasCred(){return !!localStorage.getItem('webauthn.cred');}
function toB64U(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
function fromB64U(s){s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';const b=atob(s);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return a.buffer;}
function rnd(n=32){const b=new Uint8Array(n);crypto.getRandomValues(b);return b.buffer;}

async function register(){const userId=new Uint8Array(16);crypto.getRandomValues(userId);
const publicKey={rp:{name:'PrivateBudget'},user:{id:userId,name:'local-user',displayName:'Local User'},pubKeyCredParams:[{type:'public-key',alg:-7}],authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required',residentKey:'required'},timeout:60000,challenge:new Uint8Array(rnd(32))};
const cred=await navigator.credentials.create({publicKey});const rawId=new Uint8Array(cred.rawId);
localStorage.setItem('webauthn.cred',toB64U(rawId));}
async function login(){const idb64=localStorage.getItem('webauthn.cred');const allow=[{id:new Uint8Array(fromB64U(idb64)),type:'public-key',transports:['internal']}];
const publicKey={challenge:new Uint8Array(rnd(32)),allowCredentials:allow,timeout:60000,userVerification:'required'};
await navigator.credentials.get({publicKey});}

function renderCats(){
 const c=$('#cat'); c.innerHTML='';
 const type=$('#type').value;
 const opts= type==='expense'?['ä¿é½¡çƒ','æ©Ÿè»Š','é£Ÿç‰©','å…¶ä»–']:['åª½åª½çš„æ„›','å·¥è³‡'];
 opts.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;c.appendChild(o);});
}

function render(){
 const mkey=$('#monthPick').value||ym(); const m=ensureMonth(mkey);
 const total=statsAll();
 $('#targetShow').textContent=DB.target;
 $('#savedTotal').textContent=total.toLocaleString();
 const pct=DB.target?Math.min(100,(total/DB.target*100)):0;
 $('#bar').style.width=pct+'%'; $('#barpct').textContent=pct.toFixed(1)+'%';
 $('#start').value=m.start||'';
 $('#plan').value=m.plan!==null?m.plan:'';
 $('#plan').disabled = (m.plan!==null); // locked after confirm
 const entries=m.entries||[];
 const exp=entries.filter(x=>x.type==='expense').reduce((a,b)=>a+b.amount,0);
 const inc=entries.filter(x=>x.type==='income').reduce((a,b)=>a+b.amount,0);

 // average daily: if selected month is current month => use today's date; else use full days in that month
 const [yy,mm]=mkey.split('-').map(Number);
 const mIsCurrent = (mkey === ym());
 const days = mIsCurrent ? (new Date()).getDate() : new Date(yy, mm, 0).getDate();
 const avg = days ? Math.round(exp/days) : 0;

 // last month diff: (last balance) - (last plan)
 const keys = Object.keys(DB.months).sort(); // ascending
 const idx = keys.indexOf(mkey);
 let lastDiff = 'ç„¡ä¸Šæœˆè³‡æ–™';
 if (idx>0) {
   const lastKey = keys[idx-1];
   const last = DB.months[lastKey] || {start:0, entries:[], plan:null};
   const le=(last.entries||[]).filter(x=>x.type==='expense').reduce((a,b)=>a+b.amount,0);
   const li=(last.entries||[]).filter(x=>x.type==='income').reduce((a,b)=>a+b.amount,0);
   const bal=(last.start||0)+li-le;
   if(last.plan!==null){
     const d=bal - last.plan;
     lastDiff = (d>=0?'ç¯€çœ':'è¶…æ”¯') + Math.abs(Math.round(d)) + 'å…ƒ';
   } else {
     lastDiff = 'ä¸Šæœˆæœªè¨­å®šé è¨ˆé–‹éŠ·';
   }
 }

 const diffPlan = (m.plan!==null) ? (exp - m.plan) : null;
 const planLine = (m.plan!==null) ? ('é è¨ˆï¼š'+m.plan+'ã€€å·²ç”¨ '+(exp/m.plan*100).toFixed(1)+'%ã€€å·®é¡ï¼š'+Math.round(diffPlan)) : 'å°šæœªè¨­å®šé è¨ˆé–‹éŠ·';

 $('#summary').innerHTML = `æœ¬æœˆæ”¯å‡ºï¼š${exp}ã€€å¹³å‡æ¯æ—¥é–‹éŠ·ï¼š${avg}ã€€${planLine}<br>ä¸Šæœˆå·®é¡ï¼š${lastDiff}`;

 const list=$('#listArea');list.innerHTML='';
 entries.slice().reverse().forEach(e=>{
   const div=document.createElement('div');div.className='listitem';
   div.innerHTML=`<span>${e.type==='income'?'æ”¶å…¥':'æ”¯å‡º'} Â· ${e.cat||'(æœªåˆ†é¡)'} Â· ${e.amount} â€” ${e.note||''}</span><button class="danger smallbtn" data-id="${e.id}">ğŸ—‘ï¸</button>`;
   list.appendChild(div);
 });
 list.querySelectorAll('button[data-id]').forEach(btn=>btn.addEventListener('click',ev=>{
   const id=parseInt(ev.target.dataset.id);m.entries=m.entries.filter(x=>x.id!==id);save();render();
 }));

 renderDebt();
}

function renderDebt(){
 const dlist=$('#debtList'); dlist.innerHTML='';
 DB.debts.forEach((d,i)=>{
  const div=document.createElement('div');div.className='listitem';
  div.innerHTML=`<span>${d.name} â€” ${d.amount}å…ƒ</span><button class="danger smallbtn" data-i="${i}">ğŸ—‘ï¸</button>`;
  dlist.appendChild(div);
 });
 dlist.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click',ev=>{
  const i=parseInt(ev.target.dataset.i);DB.debts.splice(i,1);save();renderDebt();
 }));
}

function openApp(){ $('#intro').classList.add('hidden'); $('#app').classList.remove('hidden'); $('#debt').classList.remove('hidden'); render(); resetIdle(); }
function lockApp(){ $('#intro').classList.remove('hidden'); $('#app').classList.add('hidden'); $('#debt').classList.add('hidden'); clearTimeout(idleTimer); }
let idleTimer=null; function resetIdle(){ clearTimeout(idleTimer); idleTimer=setTimeout(()=>{alert('é–’ç½®è¶…é3åˆ†é˜ï¼Œå·²è‡ªå‹•ä¸Šé–'); lockApp();},3*60*1000);}

function renderCats(){
 const c=$('#cat'); c.innerHTML='';
 const type=$('#type').value;
 const opts= type==='expense'?['ä¿é½¡çƒ','æ©Ÿè»Š','é£Ÿç‰©','å…¶ä»–']:['åª½åª½çš„æ„›','å·¥è³‡'];
 opts.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;c.appendChild(o);});
}

function wire(){
 $('#btnDebug').addEventListener('click',()=>alert('JS æ­£å¸¸ âœ…'));
 $('#btnRegister').addEventListener('click',async()=>{try{await register();$('#btnLogin').classList.remove('hidden');alert('è¨»å†ŠæˆåŠŸ');}catch(e){alert(e.message);}});
 $('#btnLogin').addEventListener('click',async()=>{try{await login();openApp();}catch(e){alert(e.message);}});

 $('#type').addEventListener('change',()=>{renderCats();});
 $('#monthPick').value=ym(); $('#monthPick').addEventListener('change',()=>{render();resetIdle();});
 $('#start').addEventListener('change',()=>{const v=parseFloat($('#start').value||'0');const m=ensureMonth($('#monthPick').value||ym());m.start=isFinite(v)?v:0;save();render();});
 $('#plan').addEventListener('change',()=>{const v=parseFloat($('#plan').value||'0');if(!isFinite(v)||v<=0){alert('è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡');return;}if(confirm('è¨­å®šé è¨ˆé–‹éŠ· '+v+' å…ƒï¼Ÿç¢ºå®šå¾Œå°‡é–å®šä¸å¯ä¿®æ”¹ã€‚')){const m=ensureMonth($('#monthPick').value||ym());m.plan=v;$('#plan').disabled=true;save();render();}else{$('#plan').value='';}});
 $('#btnAdd').addEventListener('click',()=>{
  const m=ensureMonth($('#monthPick').value||ym());
  const a=parseFloat($('#amount').value||'0'); if(!isFinite(a)||a<=0){alert('é‡‘é¡éœ€ç‚ºæ­£æ•¸');return;}
  const e={id:++m.counter,type:$('#type').value,amount:a,cat:$('#cat').value,note:($('#note').value||'').trim(),ts:Date.now()};
  m.entries.push(e);save();render();$('#amount').value='';$('#note').value='';resetIdle();
 });
 $('#btnExport').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='budget-backup.json';a.click();});
 $('#btnLock').addEventListener('click',()=>lockApp());

 // debt
 $('#btnAddDebt').addEventListener('click',()=>{const n=$('#debtor').value.trim();const a=parseFloat($('#debtamt').value||'0');if(!n||!isFinite(a)||a<=0){alert('è«‹è¼¸å…¥æ­£ç¢ºå§“åèˆ‡é‡‘é¡');return;}DB.debts.push({name:n,amount:a});$('#debtor').value='';$('#debtamt').value='';save();renderDebt();});
 document.body.addEventListener('click',resetIdle);document.body.addEventListener('keydown',resetIdle);
}

window.addEventListener('DOMContentLoaded',()=>{
 $('#jsStatus').textContent='JS å·²å•Ÿå‹• âœ…';
 load(); renderCats();
 if(supported()){ if(hasCred()) $('#btnLogin').classList.remove('hidden'); }
 wire();
});
})();
</script>
</body></html>
